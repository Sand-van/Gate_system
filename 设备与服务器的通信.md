# 总述

## 通用数据

### Device ID

Device ID为64位整数，嵌入式端可以考虑用8个uint8_t存储

Device ID是由服务器端的雪花算法生成，嵌入式端的Device ID的初始值应为0，随后服务器会分配一个ID给嵌入式端。嵌入式端只需要储存和传输，不需要处理。

### Device Name

Device Name是一串UTF-8编码字符串，代表着设备名称，本质上是一个uint8_t的数组。嵌入式端只需要储存和传输，不需要处理。

<br/>

## 传输的数据体

传输的帧模式应该如下

```
   |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
   +---------------+---------------+---------------+---------------+
   |               |                                               |
   |   Data Type   |                  Data Payload                 |
   |               |                                               |
   +---------------+---------------+---------------+---------------+
```

第一个字节为发送的数据类型（操作类型），具体如下表

### 服务端--->嵌入式端

|数据码|含义|
|--|--|
|0x81|成功响应|
|0x82|失败响应|
|0x83|配置嵌入式端信息|
|0x84|发送开门请求|
|0x85|蜂鸣报警请求|

<br/>

<br/>

### 服务端<---嵌入式端

|数据码|含义|
|--|--|
|0x01|成功响应|
|0x02|失败响应|
|0x03|发送本机信息|
|0x04|发送开门请求|

<br/>

# 数据码及其数据负载详情

## 服务端

### 0x81 成功响应

表明请求成功

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x81     |
|1 0 0 0 0 0 0 1|
+---------------+
```

### 0x82 失败响应

表明请求失败

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x82     |
|1 0 0 0 0 0 1 0|
+---------------+
```

### 0x83 配置嵌入式端信息

该信息由服务端主动发出，用于配置嵌入式系统的信息；嵌入式端配置完成之后应该再次发送 `0x03 发送本机信息`

```
   |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
   +---------------+---------------+---------------+---------------+---------------+
   |      0x83     |                           Device ID                           |
   |1 0 0 0 0 0 1 1|                            (64bit)                            |
   +---------------+---------------+---------------+---------------+---------------+
   |                           Device ID                           |
   |                            (64bit)                            | 
   +---------------+---------------+---------------+---------------+
```

- 帧头为0x83
- 64位的设备ID

### 0x84 发送开门请求

服务端主动发出开门请求

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x84     |
|1 0 0 0 0 1 0 0|
+---------------+
```

### 0x85 发送蜂鸣请求

服务端主动发出蜂鸣请求

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x85     |
|1 0 0 0 0 1 0 1|
+---------------+
```

<br/>

<br/>

## 嵌入式端

## 0x01 成功响应

表明请求成功

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x01     |
|0 0 0 0 0 0 0 1|
+---------------+
```

### 0x02 失败响应

表明请求失败

```
|0 1 2 3 4 5 6 7|
+---------------+
|      0x02     |
|0 0 0 0 0 0 0 1|
+---------------+
```

### 0x03 发送本机信息

该信息应该在socket建立连接后，嵌入式端第一时间发送给服务端

```
   |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
   +---------------+---------------+---------------+---------------+---------------+
   |      0x03     |                           Device ID                           |
   |0 0 0 0 0 0 1 1|                            (64bit)                            |
   +---------------+---------------+---------------+---------------+---------------+
   |                           Device ID                           |
   |                            (64bit)                            |
   +---------------+---------------+---------------+---------------+
```

- 帧头为0x03
- 64位的设备ID

### 0x04 发送设备开门请求

嵌入式端收到刷卡信息后，将刷卡信息发送给服务器端

```
   |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
   +---------------+---------------+---------------+---------------+---------------+
   |      0x04     |                            Card ID                            |
   |0 0 0 0 0 1 0 0|                            (64bit)                            |
   +---------------+---------------+---------------+---------------+---------------+
   |                            Card ID                            |
   |                            (64bit)                            |
   +---------------+---------------+---------------+---------------+
```

- 帧头为0x04
- > 注意，目前不知道校园卡ID的存储格式，目前按照64位的卡ID进行储存

<br/>

<br/>

# 整体通信逻辑

## 建立连接

1. 由嵌入式端发送Socket请求
2. 连接成功后，发送`0x01发送本机信息`到服务端
3. 服务器判断后，有以下一些可能
   1. 本机是新设备（Device ID = 0），则发送`0x83配置嵌入式端信息`进行配置，配置后嵌入式端应该返回`0x01成功响应`
   2. 本机是已经配置的设备（Device ID != 0）但数据库中没本机，则输入数据库，服务器端发送`0x81成功响应`
   3. 本机是已经配置的设备（Device ID != 0）且已登录设备ID列表中没有本机，则服务器端发送`0x81成功响应`
   4. 本机是已经配置的设备（Device ID != 0）但是已登录设备ID中有本机，说明该ID被占用，则服务器端发送`0x83配置嵌入式端信息`，这个信息包含一个新的ID
4. 连接成功建立，设备加入到服务端登录设备ID列表

<br/>

## 判断开门逻辑

### 嵌入式端发起开门请求

1. 嵌入式端发送`0x04发送开门请求`
2. 服务器端判断用户是否拥有权限，分别发送`0x84发送开门请求`和`0x82 失败响应`
3. 嵌入式端如果接受到`0x84发送开门请求`，则开门，并发送`0x01成功响应`

### 服务器端主动发起开门请求

1. 服务器端发送`0x84发送开门请求`
2. 嵌入式则开门，并发送`0x01成功响应`

<br/>

## 其他操作

- 服务端发送`0x85蜂鸣请求`，嵌入式端无需发送消息
- 服务器主动发送`0x83配置嵌入式端信息`进行配置，配置后嵌入式端应该返回`0x01成功响应`